import numpy as np
import unittest
from bitstring import BitStream
from qowi.decoder import Decoder
from qowi.encoder import Encoder
from qowi.wavelet import Wavelet

TEST_IMAGES = [
    np.array([
        [[255, 255, 255], [0, 0, 0]],
        [[0, 0, 0], [255, 255, 255]],
    ], dtype='uint8'),
    np.array([
        [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
        [[4, 4, 4], [4, 4, 4], [4, 4, 4], [4, 4, 4]],
        [[8, 8, 8], [8, 8, 8], [8, 8, 8], [8, 8, 8]],
        [[16, 16, 16], [16, 16, 16], [16, 16, 16], [16, 16, 16]],
    ], dtype='uint8'),
    np.array([
        [[95, 108, 109], [97, 109, 108], [93, 106, 109], [95, 111, 115]],
        [[91, 85, 76], [83, 75, 65], [91, 93, 88], [83, 85, 80]],
        [[83, 73, 63], [74, 66, 56], [80, 87, 86], [79, 87, 87]],
        [[195, 181, 167], [173, 164, 152], [75, 82, 82], [77, 88, 90]],
    ], dtype='uint8'),
    np.array([
        [[95, 108, 109], [97, 109, 108], [93, 106, 109], [95, 111, 115], [180, 202, 215], [170, 195, 214], [175, 206, 225], [189, 216, 233], [197, 213, 225], [173, 197, 204], [113, 124, 124], [147, 165, 169], [156, 176, 182], [150, 171, 175], [118, 134, 135], [115, 128, 127]],
        [[91, 85, 76], [83, 75, 65], [91, 93, 88], [83, 85, 80], [179, 199, 211], [176, 200, 220], [177, 206, 225], [191, 216, 233], [197, 214, 227], [171, 194, 202], [118, 134, 138], [134, 159, 168], [137, 159, 165], [139, 154, 158], [132, 140, 138], [134, 143, 139]],
        [[83, 73, 63], [74, 66, 56], [80, 87, 86], [79, 87, 87], [164, 180, 191], [179, 200, 217], [175, 197, 209], [185, 205, 218], [193, 207, 219], [167, 191, 201], [115, 127, 130], [148, 162, 167], [154, 169, 173], [150, 164, 168], [130, 141, 141], [125, 140, 141]],
        [[195, 181, 167], [173, 164, 152], [75, 82, 82], [77, 88, 90], [162, 177, 187], [177, 197, 212], [170, 186, 194], [179, 194, 203], [185, 196, 207], [157, 182, 193], [107, 125, 132], [130, 153, 162], [131, 154, 163], [126, 146, 153], [108, 123, 125], [113, 127, 128]],
        [[228, 213, 197], [234, 221, 206], [190, 195, 191], [162, 178, 183], [165, 172, 176], [179, 188, 192], [131, 124, 119], [111, 97, 88], [123, 119, 119], [152, 172, 181], [118, 130, 133], [140, 155, 160], [145, 160, 165], [141, 153, 156], [126, 135, 133], [127, 137, 136]],
        [[216, 201, 186], [229, 213, 199], [235, 222, 210], [141, 134, 127], [65, 42, 31], [210, 187, 159], [212, 189, 161], [79, 59, 47], [44, 20, 11], [125, 134, 136], [100, 117, 124], [116, 138, 147], [119, 141, 150], [110, 130, 136], [94, 110, 113], [98, 116, 119]],
        [[190, 171, 154], [219, 206, 194], [67, 65, 61], [84, 73, 57], [101, 84, 66], [187, 160, 134], [177, 148, 124], [133, 117, 104], [130, 114, 99], [197, 196, 190], [203, 202, 194], [190, 195, 191], [181, 186, 184], [177, 181, 177], [159, 161, 155], [150, 155, 151]],
        [[218, 205, 191], [216, 205, 192], [162, 153, 143], [188, 178, 166], [198, 183, 165], [219, 194, 168], [207, 183, 159], [175, 162, 149], [225, 213, 198], [249, 237, 222], [250, 238, 224], [250, 238, 224], [249, 237, 225], [246, 235, 223], [229, 219, 208], [224, 215, 205]],
        [[247, 231, 213], [248, 232, 213], [249, 234, 216], [240, 224, 204], [190, 168, 143], [120, 109, 91], [71, 62, 51], [165, 147, 133], [204, 190, 173], [249, 236, 222], [248, 236, 221], [246, 234, 220], [245, 234, 221], [242, 233, 223], [246, 235, 223], [245, 233, 222]],
        [[252, 236, 217], [250, 232, 213], [244, 225, 203], [213, 187, 161], [156, 132, 106], [196, 176, 149], [132, 110, 89], [138, 112, 88], [188, 171, 152], [245, 231, 214], [245, 232, 217], [245, 232, 217], [246, 233, 218], [246, 232, 219], [244, 231, 218], [240, 227, 216]],
        [[252, 235, 214], [252, 236, 215], [252, 237, 217], [241, 225, 204], [210, 189, 162], [215, 193, 164], [155, 135, 114], [137, 114, 90], [182, 165, 142], [190, 178, 161], [229, 216, 197], [233, 218, 201], [242, 227, 211], [243, 228, 214], [239, 226, 212], [239, 227, 214]],
        [[253, 238, 217], [254, 239, 215], [252, 238, 212], [244, 227, 202], [218, 199, 174], [216, 191, 158], [133, 108, 81], [81, 59, 38], [172, 145, 117], [206, 186, 162], [235, 220, 201], [249, 234, 215], [252, 237, 219], [251, 237, 220], [248, 234, 218], [241, 228, 215]],
        [[251, 237, 218], [244, 230, 211], [237, 221, 201], [237, 219, 195], [211, 192, 167], [232, 209, 179], [233, 209, 179], [198, 179, 155], [218, 199, 175], [192, 167, 142], [229, 204, 176], [244, 226, 205], [250, 234, 214], [251, 234, 215], [248, 232, 215], [245, 231, 217]],
        [[241, 226, 210], [242, 228, 211], [246, 230, 214], [245, 230, 212], [233, 219, 203], [237, 219, 197], [229, 206, 179], [220, 192, 166], [224, 201, 177], [252, 238, 211], [216, 190, 165], [198, 167, 143], [204, 178, 157], [251, 235, 214], [249, 233, 216], [241, 228, 214]],
        [[251, 235, 217], [248, 232, 216], [247, 231, 212], [234, 220, 204], [231, 217, 203], [243, 226, 207], [235, 214, 191], [194, 160, 134], [180, 148, 124], [252, 236, 214], [254, 240, 220], [254, 240, 220], [253, 239, 219], [252, 236, 216], [248, 233, 216], [241, 225, 212]],
        [[250, 233, 214], [243, 224, 205], [243, 226, 207], [245, 229, 211], [242, 226, 211], [242, 227, 212], [249, 232, 216], [245, 229, 212], [248, 232, 215], [250, 234, 216], [254, 239, 219], [252, 236, 216], [253, 236, 217], [251, 235, 215], [245, 229, 213], [240, 224, 211]]
    ], dtype = 'uint8'),
    np.array([
        [[95, 108, 109], [97, 109, 108], [93, 106, 109], [95, 111, 115]],
        [[91, 85, 76], [83, 75, 65], [91, 93, 88], [83, 85, 80]],
        [[83, 73, 63], [74, 66, 56], [80, 87, 86], [79, 87, 87]],
        [[195, 181, 167], [173, 164, 152], [75, 82, 82], [77, 88, 90]],
    ], dtype = 'uint8'),
    np.array([
        [[235, 222, 210], [141, 134, 127], [65, 42, 31], [210, 187, 159]],
        [[67, 65, 61], [84, 73, 57], [101, 84, 66], [187, 160, 134]],
        [[162, 153, 143], [188, 178, 166], [198, 183, 165], [219, 194, 168]],
        [[249, 234, 216], [240, 224, 204], [190, 168, 143], [120, 109, 91]],
    ], dtype = 'uint8'),
    np.array([
        [[95, 108, 109], [97, 109, 108], [93, 106, 109], [95, 111, 115], [180, 202, 215], [170, 195, 214], [175, 206, 225], [189, 216, 233]],
        [[91, 85, 76], [83, 75, 65], [91, 93, 88], [83, 85, 80], [179, 199, 211], [176, 200, 220], [177, 206, 225], [191, 216, 233]],
        [[83, 73, 63], [74, 66, 56], [80, 87, 86], [79, 87, 87], [164, 180, 191], [179, 200, 217], [175, 197, 209], [185, 205, 218]],
        [[195, 181, 167], [173, 164, 152], [75, 82, 82], [77, 88, 90], [162, 177, 187], [177, 197, 212], [170, 186, 194], [179, 194, 203]],
        [[228, 213, 197], [234, 221, 206], [190, 195, 191], [162, 178, 183], [165, 172, 176], [179, 188, 192], [131, 124, 119], [111, 97, 88]],
        [[216, 201, 186], [229, 213, 199], [235, 222, 210], [141, 134, 127], [65, 42, 31], [210, 187, 159], [212, 189, 161], [79, 59, 47]],
        [[190, 171, 154], [219, 206, 194], [67, 65, 61], [84, 73, 57], [101, 84, 66], [187, 160, 134], [177, 148, 124], [133, 117, 104]],
        [[218, 205, 191], [216, 205, 192], [162, 153, 143], [188, 178, 166], [198, 183, 165], [219, 194, 168], [207, 183, 159], [175, 162, 149]],
    ], dtype = 'uint8'),
    np.array([
        [[218, 111,  28],  [126, 238,  24],  [198,  57, 226],  [ 75, 132,  92],  [ 11,  11,  55],  [ 19,  25, 194],  [112,  87,  28],  [247, 236,  12],  [ 55, 211,   0],  [149,  70, 195],  [ 10,  89, 201],  [146,  78, 195],  [200, 181, 156],  [195,  54, 207],  [231, 228, 173],  [ 53, 249,  21]],
        [[245,  10, 212],  [121, 137, 123],  [193,  28, 232],  [146,   8, 105],  [192, 111,  72],  [250, 223, 112],  [ 71, 110,  56],  [ 58,  88, 143],  [205, 124, 152],  [104, 154, 113],  [108, 226,  60],  [ 45,  14, 113],  [ 93,  28, 227],  [170, 237,  84],  [201, 115,  15],  [ 91,  60, 161]],
        [[ 18, 187, 180],  [212, 191,  30],  [ 41,  68, 200],  [ 48, 105,  17],  [ 90, 134, 229],  [ 92, 188, 216],  [174, 230,  40],  [ 63, 152,  23],  [209, 182, 112],  [126,  55,  69],  [252,  67, 201],  [111, 104, 251],  [230,  27,  33],  [128,  14,   1],  [ 72, 103,  89],  [ 76, 222,  18]],
        [[175, 147,  92],  [245, 118, 226],  [238,  27,   4],  [212, 242,  14],  [181, 211,   8],  [165, 126, 137],  [226,  64,  31],  [114, 139,  85],  [254, 156,   7],  [208,  46,  16],  [ 58, 226,  70],  [ 84,  89, 203],  [156,  66, 141],  [ 91, 178,  13],  [213, 202, 242],  [112, 171,   5]],
        [[171,  17, 237],  [ 47, 142, 203],  [108, 202, 124],  [ 33,  69,  18],  [127,  12,  24],  [ 84, 211, 182],  [233, 132, 111],  [ 98, 188, 194],  [182,  85, 199],  [ 29,  74,  94],  [177, 239, 183],  [154, 167,  96],  [152,  88, 126],  [170, 183, 190],  [166, 233, 250],  [220,  50, 235]],
        [[223, 110,  20],  [255,   3, 100],  [181,  33, 250],  [ 69, 194, 140],  [ 99,  57, 132],  [203,  89, 139],  [ 89,  73,  46],  [185, 234, 136],  [  2, 192, 106],  [176,  63,  69],  [ 52, 181,  69],  [ 83,  39,  91],  [153,  80, 145],  [211, 153, 227],  [ 39,  64,  50],  [213, 114, 243]],
        [[243, 179, 224],  [252, 162, 225],  [ 14,  61, 135],  [ 36, 101,  24],  [ 36,  12,  41],  [ 63, 101,  32],  [ 57, 255,   6],  [142,  76,  17],  [ 22, 188, 131],  [ 49,  84,  62],  [152, 137, 118],  [216, 130, 235],  [187, 146,  33],  [238, 130, 107],  [ 74,  56,  12],  [104,  14, 235]],
        [[190, 107,  56],  [ 41,  50,  38],  [  3, 163, 242],  [ 39, 223, 247],  [160, 225, 184],  [191, 247, 150],  [226,  42,   3],  [100, 205,  22],  [ 65,  36, 209],  [ 46, 179,  62],  [202, 186, 185],  [181, 204, 167],  [224, 101,  97],  [228,  66,  46],  [204,  85, 164],  [ 91, 114, 193]],
        [[185,  91, 201],  [ 97,  82, 235],  [ 26, 175, 166],  [103, 178,  38],  [ 29, 108, 147],  [141,  13,  97],  [211, 198,  52],  [244, 203,  53],  [215,  83, 215],  [ 44, 143, 113],  [ 56,  72, 219],  [ 30,  79,  50],  [ 89, 248, 124],  [243, 191,   7],  [159, 171, 153],  [225,  27, 157]],
        [[237,  54,  47],  [236, 164, 133],  [113,  42, 119],  [ 84, 205,  33],  [ 44, 133, 183],  [134,  84,  91],  [184,  70,  32],  [178, 147, 239],  [ 83,   6,   5],  [194,   3, 129],  [ 79, 142, 186],  [227,  62, 140],  [ 38, 160, 196],  [ 86, 214,  38],  [  1,  23,  48],  [113,  22, 108]],
        [[ 82, 252, 114],  [210,  54,  45],  [ 94, 199,  18],  [  2, 251,  15],  [194, 153,  56],  [113, 222, 157],  [229, 172, 142],  [ 79, 105,  18],  [208,  54,  72],  [ 43, 165,  76],  [102, 118, 100],  [ 63, 221, 191],  [161, 161,  23],  [222, 114,   4],  [246,   4,  77],  [150, 216, 244]],
        [[110,  80,  84],  [ 86, 231, 245],  [ 88, 190,  39],  [155, 218, 125],  [145,  31,  91],  [237, 132,  40],  [190, 119,  18],  [200, 211,  78],  [129,   7,  68],  [ 57, 155,  83],  [124,  28, 202],  [ 41, 201,  13],  [161, 175, 206],  [ 13, 104,   6],  [163, 122, 123],  [182,  53,  13]],
        [[197, 140, 145],  [ 12, 206, 249],  [ 91,  80,  72],  [ 14,  14, 125],  [221, 210, 247],  [175,   5,  16],  [218,  98, 236],  [ 34,  60, 169],  [ 52, 151,   9],  [122,  41, 192],  [126, 126,  62],  [237, 146, 139],  [174, 196,  53],  [ 52, 221, 221],  [  1,  44,  17],  [160, 233, 130]],
        [[ 74, 109,   8],  [ 14, 213,  43],  [130, 157, 255],  [ 40, 230,   0],  [185, 128, 199],  [ 56, 121, 131],  [ 62, 116,  95],  [148,  58, 140],  [ 31, 124,  51],  [  5, 181,   4],  [ 77, 148, 156],  [ 26, 110, 164],  [ 62, 188, 130],  [107, 100,  92],  [ 86,  18, 195],  [165,  20,  84]],
        [[ 14, 134,  15],  [ 93,  74, 126],  [ 12, 238,  98],  [236, 207,  13],  [165, 119,  23],  [111, 244, 107],  [ 57,  75, 231],  [100,  38,  55],  [106, 117,  94],  [194,  12, 239],  [189,  13, 120],  [224, 126, 127],  [145,  15,  59],  [ 58, 255,  52],  [225, 167,  31],  [130, 194, 229]],
        [[117, 161,  26],  [169, 167, 221],  [139, 176,  81],  [207,  95,  81],  [190, 167, 170],  [ 81,  56,  70],  [170, 221,  91],  [ 16, 201, 141],  [ 71, 130, 197],  [177,  88,  88],  [245, 251, 127],  [ 97,  90, 148],  [197,  94,  64],  [ 76, 163, 121],  [102,  10, 209],  [176, 114, 223]],
    ], dtype=np.uint8),
    np.array([[[152, 221,  66],
        [143,  10, 200],
        [224, 110,  26],
        [255, 212,  45],
        [115, 177, 239],
        [175,   7,  83],
        [103,  32,  42],
        [107, 178,  73],
        [129, 220,  48],
        [ 53,  33,  41],
        [128, 190, 193],
        [161, 164, 134],
        [189, 146,  37],
        [ 92,  16, 247],
        [223, 254,  75],
        [ 20, 226, 131]],

       [[124, 181, 220],
        [ 23, 136, 148],
        [255, 114, 155],
        [ 37,  99, 205],
        [168,  28, 154],
        [110,  67,  10],
        [ 24, 211, 201],
        [232,  10, 189],
        [158, 158, 250],
        [205, 167, 127],
        [102,   0, 163],
        [ 53,  28, 199],
        [ 60, 154,  24],
        [162, 217, 127],
        [254, 108, 216],
        [122, 209, 233]],

       [[151,  37,  68],
        [167,  62, 123],
        [ 46, 211, 142],
        [247,  23, 144],
        [195, 144,   4],
        [ 50, 127, 122],
        [122, 161,  73],
        [173, 196, 240],
        [ 20, 129,  34],
        [139,  50, 250],
        [163, 247,  99],
        [215,   8, 106],
        [ 70,  27, 238],
        [116, 220, 146],
        [ 12, 177,  11],
        [ 66, 214,  91]],

       [[220,  47,  14],
        [217, 174,  52],
        [217,  22,   5],
        [185, 211, 208],
        [ 74, 246,  40],
        [ 85,  58, 103],
        [134,  90, 112],
        [ 97,  40, 127],
        [166,  96, 236],
        [116, 204, 228],
        [130, 221, 230],
        [196,  76,  68],
        [204,  20, 141],
        [ 22, 216, 206],
        [149,   2, 160],
        [114, 165, 160]],

       [[190, 171,  27],
        [175, 220,  92],
        [ 42, 173, 130],
        [184,  50, 201],
        [209,   6,  40],
        [138, 136, 129],
        [142,  36, 223],
        [163,  84, 181],
        [140,  63, 104],
        [216, 165,  85],
        [ 86,  14, 174],
        [143,   2, 221],
        [123,  10,   8],
        [ 37, 245, 115],
        [172,  22, 128],
        [112,  61, 242]],

       [[255, 119,  38],
        [240,   2, 222],
        [108,  89, 232],
        [ 15, 220, 165],
        [ 73, 135, 191],
        [ 46, 185,  96],
        [ 96,  80,  75],
        [233, 221,  58],
        [249,  80,  85],
        [ 36, 231,  94],
        [ 56,  38, 234],
        [ 46, 153, 143],
        [ 15,  38, 172],
        [ 19, 182,   3],
        [190, 169,   1],
        [ 90,  16, 147]],

       [[121,  37, 170],
        [127,  48,  16],
        [133, 134, 100],
        [ 55, 230, 100],
        [216, 188, 150],
        [155, 245, 178],
        [202,   0, 153],
        [196,  75, 172],
        [160, 229, 177],
        [196, 248,  88],
        [109,  90, 200],
        [170,  47, 115],
        [170, 235, 110],
        [220,  77,  53],
        [162, 129, 156],
        [ 36,   8, 189]],

       [[175, 234, 233],
        [124,  69, 244],
        [202, 125, 249],
        [ 17,  41, 201],
        [ 90,  75,  78],
        [ 76,  29,  53],
        [191,  93, 192],
        [232,  17, 218],
        [181, 200, 195],
        [228, 225, 242],
        [ 94, 180, 144],
        [215,  52,  61],
        [246, 236, 107],
        [126,  25, 243],
        [ 42, 249, 118],
        [114,  14, 218]],

       [[152, 227,  94],
        [249,  66,  23],
        [ 88, 106, 108],
        [170, 192,  16],
        [226, 146,  64],
        [191,  71, 152],
        [ 13,  63,  22],
        [181,  58, 212],
        [ 84, 144, 199],
        [ 39, 219,  19],
        [241,  83, 159],
        [157,  80, 162],
        [186, 167, 143],
        [101, 212, 231],
        [106, 189,  96],
        [121, 225,  55]],

       [[173, 218,  42],
        [105,  86,  56],
        [165, 103,  30],
        [148,  78,   2],
        [ 52, 126,  33],
        [230, 109, 207],
        [ 88, 168, 123],
        [ 46,  91, 150],
        [137,  67, 140],
        [203, 119,  29],
        [249,  86, 172],
        [168,   4, 168],
        [134, 176, 254],
        [ 33,  30,  18],
        [ 30, 110, 127],
        [158, 136,  54]],

       [[101, 201, 154],
        [ 70, 192,  96],
        [ 15,  18, 141],
        [230,   3, 176],
        [165, 163,  42],
        [ 25, 251, 109],
        [161, 100, 110],
        [186,  16, 242],
        [239, 136,  63],
        [235,   2,  69],
        [ 26, 177, 222],
        [197,  67, 254],
        [207, 107, 167],
        [222, 159, 180],
        [192, 172, 183],
        [204, 153,  81]],

       [[ 97,  15,  24],
        [208,  76,   4],
        [ 93,  39, 226],
        [249, 216,  49],
        [227, 124,  87],
        [216, 176,  57],
        [227,  45,  63],
        [172,  11, 186],
        [199, 215,  76],
        [ 32, 115,  42],
        [203, 224, 225],
        [ 68,  97,  27],
        [ 44, 178,  41],
        [103, 131, 136],
        [165, 104, 147],
        [ 16,  26,  76]],

       [[241,  77, 118],
        [ 43,  67, 232],
        [103, 193, 238],
        [235, 246, 216],
        [165,  90, 145],
        [250, 107,  81],
        [ 78, 160,  36],
        [140,  54, 252],
        [143, 197, 231],
        [102,  65,  32],
        [ 32, 119, 225],
        [ 87, 234, 165],
        [222, 219,  81],
        [101,  25, 213],
        [189,  23, 100],
        [154, 102, 183]],

       [[ 26,   2, 218],
        [ 98,  40, 145],
        [ 75, 173, 209],
        [159, 232,   6],
        [ 69,  17,  83],
        [ 45, 119,  53],
        [ 46, 206,  71],
        [230, 120, 176],
        [131,  89, 250],
        [ 75, 248,  54],
        [160,  34, 248],
        [ 17, 115, 251],
        [ 26,  28, 222],
        [210, 230, 129],
        [169,  31, 240],
        [ 28,  88, 137]],

       [[152, 109, 218],
        [214,  41, 219],
        [ 24, 231,  80],
        [105,  71, 177],
        [182, 177, 246],
        [187,  25, 191],
        [ 87, 254,  82],
        [146,  78, 175],
        [ 37,  47, 230],
        [ 32,   0, 152],
        [218, 158, 172],
        [ 32, 146, 114],
        [165, 236, 231],
        [125, 191, 149],
        [253,  37, 116],
        [155, 234,  24]],

       [[ 76,  65,  52],
        [249,   6,  12],
        [ 84, 127, 138],
        [216, 131,  17],
        [  5, 110,  27],
        [129, 171, 101],
        [142,  37, 174],
        [110, 153, 252],
        [ 13, 165, 252],
        [ 62,  49, 176],
        [249, 225,  19],
        [ 39, 199,  77],
        [228,  86, 159],
        [ 23,  34, 175],
        [123,   8, 140],
        [ 93, 150,  33]]], dtype=np.uint8),
]

class TestEncoder(unittest.TestCase):

    def test_instantiation(self):
        d = Decoder(BitStream())
        self.assertIsInstance(d, Decoder)

    def test_instantiation_from_zero_image(self):
        source_image = TEST_IMAGES[0]
        wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(wavelet).encode()
        decoder = Decoder(BitStream(bits))
        self.assertIsInstance(decoder, Decoder)

    def test_round_trip_from_zero_image(self):
        source_image = TEST_IMAGES[0]
        wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(wavelet).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertTrue((source_image == decoded_image).all())

    def test_round_trip_from_two_image(self):
        source_image = TEST_IMAGES[2]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(source_wavelet).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertTrue((source_image == decoded_image).all())

    def test_round_trip_from_three_image(self):
        source_image = TEST_IMAGES[3]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(source_wavelet).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertTrue((source_image == decoded_image).all())

    def test_round_trip_from_zero_image_with_bit_shift_two(self):
        source_image = TEST_IMAGES[0]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(source_wavelet, 2).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertEqual(decoded_image.shape, source_image.shape)

    def test_round_trip_from_three_image_with_bit_shift_two(self):
        source_image = TEST_IMAGES[3]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(source_wavelet, 2).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertEqual(decoded_image.shape, source_image.shape)

    def test_round_trip_from_three_image_with_bit_shift_one(self):
        source_image = TEST_IMAGES[3]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        bits = Encoder(source_wavelet, 1).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertEqual(decoded_image.shape, source_image.shape)

    def test_round_trip_from_three_image_with_bit_shift_seven(self):
        source_image = TEST_IMAGES[7]
        source_wavelet = Wavelet().prepare_from_image(source_image)
        source_wavelet.apply_hard_threshold(1)
        bits = Encoder(source_wavelet, 2, 1).encode()
        decoder = Decoder(BitStream(bits))
        decoded_wavelet = decoder.decode()
        decoded_image = decoded_wavelet.as_image()
        self.assertEqual(decoded_image.shape, source_image.shape)

if __name__ == '__main__':
    unittest.main()
